name: Build PHP 8.1

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  setup-mysql:
    name: Setup MySQL 
    uses: WebFiori/workflows/.github/workflows/setup-mysql.yaml@main
    secrets: inherit

  setup-mssql:
    name: Setup SQL Server 
    uses: WebFiori/workflows/.github/workflows/setup-sql-server.yaml@main
    secrets: inherit

  create-mssql-db:
    name: Create MSSQL Test DB
    runs-on: ubuntu-latest
    needs: setup-mssql
    steps:
      - name: Create DB
        run: /opt/mssql-tools18/bin/sqlcmd -S localhost -U SA -P ${{ secrets.SA_SQL_SERVER_PASSWORD }} -Q 'create database testing_db' -C
    
  create-mysql-db:
    name: Create MySQL Test Database
    runs-on: ubuntu-latest
    needs: setup-mysql
    steps:
      - name: Create MySQL Test DB
        run: |
          mysql -h 127.0.0.1 -u root -p${{ secrets.MYSQL_ROOT_PASSWORD }} -e "CREATE DATABASE IF NOT EXISTS testing_db;"


  test:
    name: Run Tests
    uses: WebFiori/workflows/.github/workflows/test-php.yaml@main
    needs: ['create-mysql-db', 'create-mssql-db']
    with:
      php-version: '8.1'
    secrets: inherit

  code-coverage:
    name: Coverage
    needs: test
    uses: WebFiori/workflows/.github/workflows/coverage-codecov.yaml@main
    with:
      php-version: '8.1'
      coverage-file: 'php-8.1-coverage.xml'
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
